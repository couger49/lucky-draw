<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>3D æ˜Ÿç©ºæŠ½å¥– Â· å°Šäº«ç‰ˆ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- å¼•å…¥ Three.js -->
<script src="https://unpkg.com/three@0.152.2/build/three.min.js"></script>

<style>
/* --- å…¨å±€æ ·å¼ --- */
body {
    margin: 0;
    overflow: hidden;
    font-family: "Microsoft YaHei", "PingFang SC", sans-serif;
    background: #000;
    color: #fff;
    user-select: none;
}

/* --- UI è®¾ç½®é¢æ¿ --- */
#ui {
    position: fixed;
    top: 10px;
    left: 10px;
    z-index: 20;
    background: rgba(20, 10, 0, 0.9);
    padding: 15px 20px;
    border-radius: 12px;
    width: 300px;
    border: 1px solid #5c3a1e;
    box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    backdrop-filter: blur(8px);
    transition: transform 0.4s cubic-bezier(0.22, 1, 0.36, 1), opacity 0.4s;
    transform: translateX(0);
    opacity: 1;
    max-height: 90vh;
    overflow-y: auto;
}

#ui.hidden {
    transform: translateX(-380px);
    opacity: 0;
    pointer-events: none;
}

/* æ»šåŠ¨æ¡æ ·å¼ */
#ui::-webkit-scrollbar { width: 6px; }
#ui::-webkit-scrollbar-thumb { background: #5c3a1e; border-radius: 3px; }

label {
    display: block;
    font-size: 14px;
    color: #ffaa55;
    margin-bottom: 4px;
    margin-top: 12px;
    font-weight: bold;
}

.setting-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 12px;
    color: #ccc;
    margin-bottom: 5px;
}

input[type="range"] {
    width: 100%;
    cursor: pointer;
    accent-color: #ffaa00;
}

/* æ–‡æœ¬æ¡†ä¸è¾“å…¥æ¡†é€šç”¨æ ·å¼ */
textarea, input[type="text"] {
    width: 100%;
    background: rgba(0,0,0,0.4);
    border: 1px solid #664422;
    color: #ffd28a;
    padding: 8px;
    border-radius: 6px;
    outline: none;
    font-size: 13px;
    box-sizing: border-box;
}

textarea { height: 60px; resize: vertical; }
textarea:focus, input[type="text"]:focus {
    border-color: #ffaa00;
    background: rgba(0,0,0,0.6);
}

/* éŸ³ä¹ä¸Šä¼ æ§ä»¶ */
.file-upload {
    margin-top: 5px;
    position: relative;
    overflow: hidden;
    display: inline-block;
    width: 100%;
}
.file-upload input[type=file] {
    font-size: 12px;
    color: #ffd28a;
}

button {
    width: 100%;
    margin-top: 10px;
    padding: 10px;
    background: linear-gradient(to bottom, #d4af37, #a67c00);
    border: none;
    border-radius: 6px;
    color: #2b1200;
    font-weight: bold;
    font-size: 15px;
    cursor: pointer;
    transition: 0.2s;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
}

button.secondary-btn {
    margin-top: 5px;
    padding: 6px;
    font-size: 13px;
    background: linear-gradient(to bottom, #5c3a1e, #3d2410);
    color: #ffd28a;
    box-shadow: none;
    border: 1px solid #664422;
}

button:hover { filter: brightness(1.2); transform: translateY(-1px); }
button:active { transform: translateY(1px); }
button:disabled {
    background: #555 !important;
    color: #aaa !important;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

.close-btn {
    position: absolute;
    top: 10px;
    right: 15px;
    cursor: pointer;
    font-size: 22px;
    color: #886644;
    transition: 0.2s;
    line-height: 1;
}
.close-btn:hover { color: #ffaa00; }

#open-btn {
    position: fixed;
    top: 10px;
    left: 10px;
    width: 44px;
    height: 44px;
    background: rgba(20, 10, 0, 0.6);
    border: 1px solid #5c3a1e;
    border-radius: 50%;
    color: #ffd28a;
    font-size: 22px;
    text-align: center;
    line-height: 42px;
    cursor: pointer;
    z-index: 10;
    transition: 0.3s;
    opacity: 0;
    pointer-events: none;
    box-shadow: 0 0 10px rgba(255, 170, 0, 0.2);
}
#open-btn:hover { background: rgba(40, 20, 0, 0.9); color: #fff; transform: rotate(90deg); }
body.ui-closed #open-btn { opacity: 1; pointer-events: auto; }

/* --- å¤§å¥–å±•ç¤º --- */
#prizeTitle {
    position: fixed;
    top: 10%;
    width: 100%;
    text-align: center;
    /* font-size é»˜è®¤å€¼ï¼Œä¼šè¢«JSè¦†ç›– */
    font-size: 42px; 
    font-weight: bold;
    color: #ffd28a;
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.8);
    pointer-events: none;
    letter-spacing: 2px;
    z-index: 5;
    transition: font-size 0.3s; /* å¹³æ»‘è¿‡æ¸¡ */
}

#bigWinner {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 90%;
    text-align: center;
    font-size: 90px;
    font-weight: 900;
    line-height: 1.2;
    z-index: 100;
    pointer-events: none;
    background: linear-gradient(110deg, #bf953f 0%, #fcf6ba 25%, #b38728 50%, #fbf5b7 75%, #aa771c 100%);
    background-size: 200% auto;
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    filter: drop-shadow(0 0 20px rgba(255, 160, 0, 0.6));
    opacity: 0;
    transition: opacity 0.3s;
}

.show-winner {
    opacity: 1 !important;
    animation: shine 4s linear infinite, popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.27) forwards;
}

@keyframes shine { to { background-position: 200% center; } }
@keyframes popIn { 0% { transform: translate(-50%, -50%) scale(0.2); } 100% { transform: translate(-50%, -50%) scale(1); } }

.footer-tip {
    position: fixed;
    bottom: 10px;
    right: 15px;
    font-size: 12px;
    color: rgba(255,255,255,0.3);
    pointer-events: none;
}
</style>
</head>

<body>

<!-- æ‚¬æµ®æ‰“å¼€æŒ‰é’® -->
<div id="open-btn" onclick="toggleUI()" title="æ‰“å¼€è®¾ç½® (å¿«æ·é”® H)">âš™</div>

<!-- è®¾ç½®é¢æ¿ -->
<div id="ui">
    <div class="close-btn" onclick="toggleUI()" title="éšè— (å¿«æ·é”® H)">Ã—</div>
    
    <div style="text-align:center; color:#ffd28a; font-size:18px; font-weight:bold; margin-bottom:15px; border-bottom:1px solid #5c3a1e; padding-bottom:10px;">
        âš™ æŠ½å¥–è®¾ç½®
    </div>

    <!-- è§†è§‰è°ƒæ•´ -->
    <label>ğŸ‘ï¸ è§†è§‰ä¸æ–‡å­—è°ƒæ•´</label>
    
    <!-- æ ‡é¢˜å­—å· -->
    <div class="setting-row">
        <span>æ ‡é¢˜å­—å· ("å‡†å¤‡æŠ½å¥–")</span>
        <span id="val-title-size">42px</span>
    </div>
    <input type="range" id="title-size-slider" min="20" max="150" value="42" oninput="updateVisuals()">

    <!-- çƒä½“å¤§å° -->
    <div class="setting-row" style="margin-top:5px;">
        <span>çƒä½“å¤§å°</span>
        <span id="val-radius">150</span>
    </div>
    <input type="range" id="radius-slider" min="50" max="400" value="150" oninput="updateVisuals()">
    
    <!-- çƒä¸Šåå­—å¤§å° -->
    <div class="setting-row" style="margin-top:5px;">
        <span>åå­—å¤§å°</span>
        <span id="val-font">0.3</span>
    </div>
    <input type="range" id="font-slider" min="0.1" max="1.0" step="0.05" value="0.3" oninput="updateVisuals()">

    <!-- éŸ³ä¹è®¾ç½® -->
    <label>ğŸµ èƒŒæ™¯éŸ³ä¹</label>
    
    <!-- æœ¬åœ°ä¸Šä¼  -->
    <div style="font-size:12px; color:#ccc; margin-bottom:4px;">æ–¹å¼1ï¼šæœ¬åœ°ä¸Šä¼ </div>
    <div class="file-upload">
        <input type="file" id="bgm-input" accept="audio/*" onchange="handleAudioUpload(this)">
    </div>

    <!-- ç½‘ç»œé“¾æ¥ -->
    <div style="font-size:12px; color:#ccc; margin-bottom:4px; margin-top:8px;">æ–¹å¼2ï¼šç½‘ç»œé“¾æ¥ (URL)</div>
    <input type="text" id="music-url-input" placeholder="è¾“å…¥ mp3/wav é“¾æ¥...">
    <button class="secondary-btn" onclick="loadMusicFromUrl()">ğŸ”— åŠ è½½é“¾æ¥éŸ³ä¹</button>

    <!-- éŸ³é‡ -->
    <div class="setting-row" style="margin-top:10px;">
        <span>éŸ³é‡</span>
        <span id="val-vol">50%</span>
    </div>
    <input type="range" id="vol-slider" min="0" max="1" step="0.1" value="0.5" oninput="updateVolume()">
    
    <div style="font-size:12px; color:#886; margin-top:5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" id="music-status">
        æš‚æ— éŸ³ä¹
    </div>

    <!-- åå•ä¸å¥–é¡¹ -->
    <label>ğŸ“‹ å‚ä¸åå•</label>
    <textarea id="names" placeholder="ä¾‹å¦‚ï¼š&#10;å¼ ä¸‰&#10;æå››&#10;ç‹äº”">
é»„è¯—è““
é‚¹éŸ»
æœ±æ•è¹
åˆ˜ä¸½äº‘
å¶ç‡•é’
é™ˆé’å…°
é™ˆé›…æ–°
çŸ³æ±Ÿå…µ
é—«å½¦è‰³
å´ç»®å§—
è”¡ä¼¯æ»”
æ›¾æ¼«æ€
ä½•ç¾äº‘
é‚“é“–ç
æ¯•æ…§é›¯
ä½™æ±‰å±
ç‹é›¨å›
ç½—é‘«é“¿
è®¸æ–‡æ´
ç‹å¥•è²
æ¯›æ˜™æºª
æé™
å‘¨é¢–ç¦
éƒ‘ä»²ç«‹
ææ°å®‡
ææ¶›
</textarea>

    <label>ğŸ† å¥–é¡¹è®¾ç½®</label>
    <textarea id="prizes">
é˜³å…‰æ™®ç…§å¥–(ä¿æ¸©æ¯),15
é˜³å…‰æ™®ç…§å¥–(å…»ç”Ÿå£¶),5
ä¸‰ç­‰å¥–(è±†æµ†æœº),3
äºŒç­‰å¥–(çœ¼éƒ¨æŒ‰æ‘©ä»ª),2
ä¸€ç­‰å¥–(é¢ˆéƒ¨æŒ‰æ‘©ä»ª),1
</textarea>

    <button onclick="applySettings()" style="margin-top:15px;">ğŸ”„ æ›´æ–°åå• & é‡ç½®</button>
    <button onclick="draw()" id="drawBtn">ğŸ° å¼€å§‹ (Enter é”®)</button>
    
    <div style="text-align:center; font-size:12px; color:#664422; margin-top:8px;">
        æç¤ºï¼šæŒ‰ Enter æŠ½å¥–ï¼ŒH éšè—é¢æ¿
    </div>
</div>

<div id="prizeTitle"></div>
<div id="bigWinner"></div>
<div class="footer-tip">Enter æŠ½å¥– | H éšè—é¢æ¿ | ç©ºæ ¼ æš‚åœ</div>

<script>
// --- æ ¸å¿ƒå˜é‡ ---
let scene, camera, renderer;
let nameSprites = []; 
let participants = []; 
let candidates = [];   
let prizes = [];
let prizeIndex = 0;
let rotating = true;
let stars;
let isDrawing = false; 

// è§†è§‰ä¸éŸ³é¢‘å˜é‡
let sphereRadius = 150;
let textScale = 0.3;
let bgmAudio = new Audio();
bgmAudio.loop = true;

// åˆå§‹åŒ–
init();
animate();

function init() {
    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x1a0b00); 
    scene.fog = new THREE.Fog(0x1a0b00, 300, 1200);

    camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 1, 2000);
    camera.position.z = 450; 

    renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(window.devicePixelRatio);
    document.body.appendChild(renderer.domElement);

    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });
    
    window.addEventListener("keydown", handleKeydown);

    createStars();
    applySettings(); // ä¹Ÿä¼šè°ƒç”¨ renderSphere
    updateVisuals(); // åˆå§‹åŒ–è§†è§‰è®¾ç½®
}

// --- è§†è§‰è°ƒæ•´é€»è¾‘ ---
function updateVisuals() {
    // è·å–æ»‘æ†çš„å€¼
    const rVal = document.getElementById("radius-slider").value;
    const fVal = document.getElementById("font-slider").value;
    const tVal = document.getElementById("title-size-slider").value;

    // æ›´æ–°æ˜¾ç¤ºæ•°å€¼
    document.getElementById("val-radius").innerText = rVal;
    document.getElementById("val-font").innerText = fVal;
    document.getElementById("val-title-size").innerText = tVal + "px";

    // æ›´æ–°å˜é‡å’ŒDOM
    sphereRadius = parseInt(rVal);
    textScale = parseFloat(fVal);
    document.getElementById("prizeTitle").style.fontSize = tVal + "px";

    // é‡æ–°æ¸²æŸ“çƒä½“
    renderSphere();
}

// --- éŸ³é¢‘é€»è¾‘ ---
function handleAudioUpload(input) {
    const file = input.files[0];
    if (file) {
        const fileURL = URL.createObjectURL(file);
        playMusic(fileURL, "ğŸ“‚ " + file.name);
    }
}

function loadMusicFromUrl() {
    const url = document.getElementById("music-url-input").value;
    if (url) {
        playMusic(url, "ğŸ”— ç½‘ç»œéŸ³ä¹");
    } else {
        alert("è¯·å…ˆè¾“å…¥éŸ³ä¹é“¾æ¥ï¼");
    }
}

function playMusic(src, displayName) {
    bgmAudio.src = src;
    bgmAudio.volume = document.getElementById("vol-slider").value;
    bgmAudio.play().then(() => {
        document.getElementById("music-status").innerText = "ğŸ¶ æ­£åœ¨æ’­æ”¾: " + displayName;
        document.getElementById("music-status").style.color = "#aaffaa";
    }).catch(err => {
        console.error(err);
        document.getElementById("music-status").innerText = "âš ï¸ æ’­æ”¾å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ ¼å¼æˆ–ç‚¹å‡»é¡µé¢";
        document.getElementById("music-status").style.color = "#ff5555";
    });
}

function updateVolume() {
    const vol = document.getElementById("vol-slider").value;
    bgmAudio.volume = vol;
    document.getElementById("val-vol").innerText = Math.round(vol * 100) + "%";
}

// --- æ˜Ÿç©º ---
function createStars() {
    const starGeometry = new THREE.BufferGeometry();
    const starCount = 1800;
    const positions = [];
    const colors = [];
    const colorObj = new THREE.Color();

    for (let i = 0; i < starCount; i++) {
        positions.push(
            (Math.random() - 0.5) * 2000,
            (Math.random() - 0.5) * 2000,
            (Math.random() - 0.5) * 2000
        );
        if(Math.random() > 0.9) colorObj.setHex(0xffaa00);
        else if(Math.random() > 0.6) colorObj.setHex(0xffffff);
        else colorObj.setHex(0xffdab9);
        colors.push(colorObj.r, colorObj.g, colorObj.b);
    }
    starGeometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
    starGeometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
    const starMaterial = new THREE.PointsMaterial({
        vertexColors: true,
        size: 2.5,
        transparent: true,
        opacity: 0.9
    });
    stars = new THREE.Points(starGeometry, starMaterial);
    scene.add(stars);
}

// --- æ–‡å­— Sprite ---
function createTextSprite(text) {
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");
    const fontSize = 56;
    ctx.font = "bold " + fontSize + "px 'Microsoft YaHei', Arial";
    const textWidth = ctx.measureText(text).width;
    canvas.width = textWidth + 40;
    canvas.height = fontSize + 40;

    ctx.font = "bold " + fontSize + "px 'Microsoft YaHei', Arial";
    ctx.fillStyle = "#ffd28a"; 
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.shadowColor = "rgba(0,0,0,0.8)";
    ctx.shadowBlur = 6;
    ctx.fillText(text, canvas.width / 2, canvas.height / 2);

    const texture = new THREE.CanvasTexture(canvas);
    texture.minFilter = THREE.LinearFilter; 
    
    const material = new THREE.SpriteMaterial({ map: texture, transparent: true, color: 0xffffff });
    const sprite = new THREE.Sprite(material);
    
    // ä½¿ç”¨å…¨å±€å˜é‡ textScale
    sprite.scale.set(canvas.width * textScale, canvas.height * textScale, 1);
    sprite.userData = { name: text }; 

    return sprite;
}

// --- æ¸²æŸ“çƒä½“ ---
function renderSphere() {
    nameSprites.forEach(s => scene.remove(s));
    nameSprites = [];

    const count = participants.length;
    // ä½¿ç”¨å…¨å±€å˜é‡ sphereRadius
    const radius = sphereRadius; 

    for(let i = 0; i < count; i++) {
        const phi = Math.acos(1 - 2 * (i + 0.5) / count);
        const theta = Math.PI * (1 + Math.sqrt(5)) * (i + 0.5);
        const x = radius * Math.sin(phi) * Math.cos(theta);
        const y = radius * Math.sin(phi) * Math.sin(theta);
        const z = radius * Math.cos(phi);

        const sprite = createTextSprite(participants[i]);
        sprite.position.set(x, y, z);
        scene.add(sprite);
        nameSprites.push(sprite);
    }
}

// --- åº”ç”¨è®¾ç½® ---
function applySettings() {
    const namesText = document.getElementById("names").value;
    const prizesText = document.getElementById("prizes").value;

    participants = namesText.split(/[ \t\n,ï¼Œ;ï¼›]+/)
        .map(n => n.trim())
        .filter(n => n.length > 0);
    participants = [...new Set(participants)];
    candidates = [...participants];

    prizes = prizesText.split("\n")
        .map(line => {
            if(!line.trim()) return null;
            let parts = line.replace(/ï¼Œ/g, ',').split(",");
            let name = parts[0].trim();
            let count = parseInt(parts[1]);
            if(isNaN(count)) count = 1;
            return { name, count };
        }).filter(p => p);

    prizeIndex = 0;
    rotating = true;
    isDrawing = false;
    
    document.getElementById("prizeTitle").innerText = "å‡†å¤‡æŠ½å¥–";
    document.getElementById("bigWinner").innerText = "";
    document.getElementById("bigWinner").className = "";
    
    const drawBtn = document.getElementById("drawBtn");
    drawBtn.innerText = "ğŸ° å¼€å§‹ (Enter é”®)";
    drawBtn.disabled = false;

    renderSphere();
    console.log(`é‡ç½®å®Œæˆï¼šæ€»åå• ${participants.length} äºº`);
}

// --- æŠ½å¥–é€»è¾‘ ---
function draw() {
    if (isDrawing) return;
    if (prizeIndex >= prizes.length) return;
    if (candidates.length === 0) {
        alert("å€™é€‰åå•å·²ç©ºï¼");
        return;
    }

    isDrawing = true;
    const currentPrize = prizes[prizeIndex];

    document.getElementById("prizeTitle").innerText = "æ­£åœ¨æŠ½å– " + currentPrize.name + "...";
    document.getElementById("bigWinner").className = "";
    document.getElementById("bigWinner").innerText = "";
    rotating = false;
    
    setTimeout(() => {
        let winners = [];
        let drawCount = Math.min(currentPrize.count, candidates.length);
        
        for (let i = 0; i < drawCount; i++) {
            const randomIdx = Math.floor(Math.random() * candidates.length);
            const winnerName = candidates[randomIdx];
            winners.push(winnerName);
            candidates.splice(randomIdx, 1);
        }

        document.getElementById("prizeTitle").innerText = "ğŸ‰ " + currentPrize.name + "å¾—ä¸» ğŸ‰";
        
        const winnerDiv = document.getElementById("bigWinner");
        if (winners.length > 5) {
            winnerDiv.style.fontSize = "50px";
            winnerDiv.innerHTML = winners.join("ã€");
        } else {
            winnerDiv.style.fontSize = "90px";
            winnerDiv.innerHTML = winners.join("<br>");
        }
        winnerDiv.classList.add("show-winner");
        
        prizeIndex++;

        if (prizeIndex >= prizes.length) {
            const drawBtn = document.getElementById("drawBtn");
            drawBtn.innerText = "ğŸŠ æŠ½å¥–ç»“æŸ";
            drawBtn.disabled = true;
        }

        setTimeout(() => {
            rotating = true;
            isDrawing = false;
        }, 1500);

    }, 800);
}

// --- UI ä¸ é”®ç›˜æ§åˆ¶ ---
function toggleUI() {
    const ui = document.getElementById("ui");
    const body = document.body;
    if (ui.classList.contains("hidden")) {
        ui.classList.remove("hidden");
        body.classList.remove("ui-closed");
    } else {
        ui.classList.add("hidden");
        body.classList.add("ui-closed");
    }
}

function handleKeydown(e) {
    const tagName = document.activeElement.tagName;
    const isInput = tagName === "TEXTAREA" || tagName === "INPUT";

    if (e.code === "Space" && !isInput) {
        rotating = !rotating;
        e.preventDefault(); 
    }
    
    if (e.key.toLowerCase() === "h" && !isInput) {
        toggleUI();
    }

    if (e.key === "Enter" && !isInput) {
        if (prizeIndex < prizes.length && !isDrawing) {
            draw();
        }
    }
}

// --- åŠ¨ç”»å¾ªç¯ ---
function animate() {
    requestAnimationFrame(animate);
    if (stars) {
        stars.rotation.y += 0.0003;
        stars.rotation.x += 0.0001;
    }
    if (rotating) {
        scene.rotation.y += 0.003;
        scene.rotation.x = Math.sin(Date.now() * 0.001) * 0.1; 
    }
    renderer.render(scene, camera);
}
</script>

</body>
</html>
